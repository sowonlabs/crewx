# WBS-4 Job-8: ê¸°ìˆ  ìŠ¤íƒ ê²€í†  (better-sqlite3, WAL)

> **ì‘ì—…ì¼**: 2025-12-18
> **ë‹´ë‹¹ì**: crewx_claude_dev
> **ìƒíƒœ**: âœ… ê²€í†  ì™„ë£Œ
> **ê´€ë ¨ WBS**: WBS-36 (Observability Design Review)

---

## ğŸ“‹ ê°œìš”

CrewX Observability ì‹œìŠ¤í…œì—ì„œ ì‚¬ìš©í•  SQLite ê¸°ìˆ  ìŠ¤íƒì— ëŒ€í•œ ê¸°ìˆ  ê²€í†  ë³´ê³ ì„œì…ë‹ˆë‹¤.
`.crewx/traces.db` íŒŒì¼ì— ì—ì´ì „íŠ¸ í–‰ìœ„ë¥¼ ì¶”ì í•˜ê¸° ìœ„í•´ **better-sqlite3** ë¼ì´ë¸ŒëŸ¬ë¦¬ì™€ **WAL (Write-Ahead Logging)** ëª¨ë“œë¥¼ ì„ íƒí•œ ê·¼ê±°ë¥¼ ë¶„ì„í•©ë‹ˆë‹¤.

---

## 1. better-sqlite3 ë¼ì´ë¸ŒëŸ¬ë¦¬ ê²€í† 

### 1.1 ë¼ì´ë¸ŒëŸ¬ë¦¬ ê°œìš”

| í•­ëª© | ë‚´ìš© |
|------|------|
| **íŒ¨í‚¤ì§€ëª…** | [better-sqlite3](https://www.npmjs.com/package/better-sqlite3) |
| **ìµœì‹  ë²„ì „** | 12.4.1 (2025ë…„ ê¸°ì¤€) |
| **GitHub** | [WiseLibs/better-sqlite3](https://github.com/WiseLibs/better-sqlite3) |
| **ë¼ì´ì„ ìŠ¤** | MIT |
| **Node.js ìš”êµ¬ì‚¬í•­** | v14.21.1 ì´ìƒ |
| **TypeScript ì§€ì›** | âœ… (@types/better-sqlite3) |

### 1.2 ì£¼ìš” íŠ¹ì§•

#### âœ… ë™ê¸°ì‹ API (Synchronous API)
```javascript
const db = require('better-sqlite3')('foobar.db');
const row = db.prepare('SELECT * FROM users WHERE id = ?').get(userId);
```

- **ì¥ì **: ì´ë²¤íŠ¸ ë£¨í”„ ë³µì¡ì„± íšŒí”¼, ì‹¤ì œë¡œ ë” ë‚˜ì€ ë™ì‹œì„± ì œê³µ
- **ë¹„êµ**: `node-sqlite3`ëŠ” ë¹„ë™ê¸° APIë¥¼ ì‚¬ìš©í•˜ì§€ë§Œ ì§ë ¬í™”ëœ ì‘ì—…ì—ì„œ ì˜¤íˆë ¤ ì„±ëŠ¥ ì €í•˜
- **CrewX ì í•©ì„±**: CLI í™˜ê²½ì—ì„œ ê°„ê²°í•œ ì½”ë“œ ì‘ì„± ê°€ëŠ¥

#### âœ… ê³ ì„±ëŠ¥ (High Performance)

ë²¤ì¹˜ë§ˆí¬ ë¹„êµ (better-sqlite3 = 1x ê¸°ì¤€):
| ì‘ì—… | better-sqlite3 | ê²½ìŸ ë¼ì´ë¸ŒëŸ¬ë¦¬ |
|------|---------------|----------------|
| ë‹¨ì¼ í–‰ SELECT | 1x | 11.7x ëŠë¦¼ |
| 100í–‰ ë°°ì¹˜ ì¡°íšŒ | 1x | 2.9x ëŠë¦¼ |
| ë°˜ë³µ ë‹¨ì¼ í–‰ ì²˜ë¦¬ | 1x | 24.4x ëŠë¦¼ |

#### âœ… íŠ¸ëœì­ì…˜ ì§€ì›
- ì „ì²´ ACID íŠ¸ëœì­ì…˜ ë³´ì¥
- ê³ ì„±ëŠ¥, íš¨ìœ¨ì„±, ì•ˆì •ì„± ì œê³µ

#### âœ… ê³ ê¸‰ ê¸°ëŠ¥
- ì‚¬ìš©ì ì •ì˜ í•¨ìˆ˜ (User-defined functions)
- ì§‘ê³„ í•¨ìˆ˜ (Aggregates)
- ê°€ìƒ í…Œì´ë¸” (Virtual tables)
- í™•ì¥ ëª¨ë“ˆ ì§€ì› (Extensions)
- 64ë¹„íŠ¸ ì •ìˆ˜ ì§€ì›
- Worker Thread ì§€ì› (ëŒ€ìš©ëŸ‰ ì¿¼ë¦¬ ì²˜ë¦¬)

#### âœ… ë©”ëª¨ë¦¬ ê´€ë¦¬
- JavaScript ë°©ì‹ì˜ ë©”ëª¨ë¦¬ ê´€ë¦¬ (Garbage Collector í™œìš©)
- `node-sqlite3`ì˜ ì €ìˆ˜ì¤€ C ë©”ëª¨ë¦¬ ê´€ë¦¬ ëŒ€ë¹„ ì•ˆì „í•¨

### 1.3 ì í•©í•œ ì‚¬ìš© ì‚¬ë¡€

| ì‚¬ìš© ì‚¬ë¡€ | ì í•©ì„± |
|----------|--------|
| ì†Œê·œëª¨~ì¤‘ê·œëª¨ ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ | âœ… |
| Electron ë°ìŠ¤í¬í†± ì•± | âœ… |
| **CLI ë„êµ¬ (CrewX)** | âœ… **ìµœì ** |
| ê³ ë™ì‹œì„± ì“°ê¸° (ì†Œì…œ ë¯¸ë””ì–´) | âŒ |
| í…Œë¼ë°”ì´íŠ¸ê¸‰ ë°ì´í„°ë² ì´ìŠ¤ | âŒ |

### 1.4 CrewX ì í•©ì„± í‰ê°€

| í‰ê°€ í•­ëª© | ì ìˆ˜ | ë¹„ê³  |
|----------|------|------|
| CLI í™˜ê²½ ì í•©ì„± | â­â­â­â­â­ | ë™ê¸°ì‹ APIê°€ CLIì— ì´ìƒì  |
| ì„±ëŠ¥ | â­â­â­â­â­ | ì—…ê³„ ìµœê³  ì„±ëŠ¥ |
| TypeScript ì§€ì› | â­â­â­â­â­ | ê³µì‹ íƒ€ì… ì •ì˜ ì œê³µ |
| ìœ ì§€ë³´ìˆ˜ | â­â­â­â­â­ | í™œë°œí•œ ì»¤ë®¤ë‹ˆí‹°, ì§€ì†ì  ì—…ë°ì´íŠ¸ |
| í•™ìŠµ ê³¡ì„  | â­â­â­â­â­ | ê°„ë‹¨í•œ API |

**ê²°ë¡ **: CrewX Observability ì‹œìŠ¤í…œì— **ì í•©** âœ…

---

## 2. WAL (Write-Ahead Logging) ëª¨ë“œ ê²€í† 

### 2.1 WAL ëª¨ë“œë€?

SQLiteì˜ ì €ë„ë§ ëª¨ë“œ ì¤‘ í•˜ë‚˜ë¡œ, ê¸°ì¡´ ë¡¤ë°± ì €ë„ ë°©ì‹ ëŒ€ì‹  "ë¯¸ë¦¬ ì“°ê¸° ë¡œê·¸"ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.

```javascript
db.pragma('journal_mode = WAL');
```

### 2.2 WAL ë™ì‘ ì›ë¦¬

```
ê¸°ì¡´ ë°©ì‹ (Rollback Journal):
  1. ì›ë³¸ ë°ì´í„° â†’ ë¡¤ë°± íŒŒì¼ì— ë°±ì—…
  2. ì›ë³¸ íŒŒì¼ ì§ì ‘ ìˆ˜ì •
  3. ì™„ë£Œ ì‹œ ë¡¤ë°± íŒŒì¼ ì‚­ì œ

WAL ë°©ì‹:
  1. ë³€ê²½ì‚¬í•­ â†’ WAL íŒŒì¼ì— ì¶”ê°€ (append)
  2. ì›ë³¸ íŒŒì¼ì€ ìˆ˜ì •í•˜ì§€ ì•ŠìŒ
  3. ì²´í¬í¬ì¸íŠ¸ ì‹œ WAL â†’ ì›ë³¸ íŒŒì¼ë¡œ ë³‘í•©
```

### 2.3 WAL ëª¨ë“œì˜ ì¥ì 

#### âœ… ì„±ëŠ¥ í–¥ìƒ
- **ì“°ê¸° ì†ë„**: ext4 íŒŒì¼ì‹œìŠ¤í…œì—ì„œ ìµœëŒ€ 4ë°° í–¥ìƒ
- **I/O ìµœì í™”**: ìˆœì°¨ì  ë””ìŠ¤í¬ ì“°ê¸°ë¡œ íš¨ìœ¨ì„± ì¦ê°€
- **fsync ê°ì†Œ**: ì‹œìŠ¤í…œ ì½œ íšŸìˆ˜ ê°ì†Œë¡œ ì•ˆì •ì„± í–¥ìƒ

#### âœ… ë™ì‹œì„± ê°œì„ 
- **ì½ê¸°/ì“°ê¸° ë™ì‹œ ì‹¤í–‰**: ë¦¬ë”ê°€ ë¼ì´í„°ë¥¼ ë¸”ë¡œí‚¹í•˜ì§€ ì•ŠìŒ
- **ë‹¤ì¤‘ ë¦¬ë” ì§€ì›**: ì—¬ëŸ¬ í”„ë¡œì„¸ìŠ¤ê°€ ë™ì‹œì— ì½ê¸° ê°€ëŠ¥
- **CrewX ì‹œë‚˜ë¦¬ì˜¤**: CLI + Slack Bot ë™ì‹œ ì ‘ê·¼ ì§€ì›

#### âœ… ì•ˆì •ì„±
- ë‹¨ì¼ ë””ìŠ¤í¬ ì“°ê¸°ë¡œ ë°ì´í„° ë¬´ê²°ì„± í–¥ìƒ
- ì‹œìŠ¤í…œ ì¶©ëŒ ì‹œì—ë„ ë³µêµ¬ ê°€ëŠ¥

### 2.4 WAL ëª¨ë“œì˜ ì œí•œì‚¬í•­

| ì œí•œì‚¬í•­ | ì˜í–¥ | CrewX ì ìš© |
|----------|------|----------|
| ë„¤íŠ¸ì›Œí¬ íŒŒì¼ì‹œìŠ¤í…œ ë¯¸ì§€ì› | ë™ì¼ í˜¸ìŠ¤íŠ¸ë§Œ ì ‘ê·¼ ê°€ëŠ¥ | âœ… ë¬¸ì œì—†ìŒ (.crewx/ ë¡œì»¬ ì €ì¥) |
| ëŒ€ìš©ëŸ‰ íŠ¸ëœì­ì…˜ (100MB+) | ë¡¤ë°± ì €ë„ì´ ë” ë¹ ë¦„ | âœ… ë¬¸ì œì—†ìŒ (íŠ¸ë ˆì´ìŠ¤ëŠ” ì†Œê·œëª¨) |
| ëŒ€ìš©ëŸ‰ WAL íŒŒì¼ ì‹œ ì½ê¸° ì„±ëŠ¥ ì €í•˜ | ë‘ ìœ„ì¹˜ ê²€ìƒ‰ í•„ìš” | âœ… ì²´í¬í¬ì¸íŠ¸ ì„¤ì •ìœ¼ë¡œ í•´ê²° |

### 2.5 CrewX ìµœì í™” ì„¤ì •

```javascript
// ê¶Œì¥ ì„¤ì •
const db = new Database('.crewx/traces.db');
db.pragma('journal_mode = WAL');
db.pragma('busy_timeout = 5000');    // 5ì´ˆ ëŒ€ê¸° (ë™ì‹œ ì ‘ê·¼ ëŒ€ë¹„)
db.pragma('synchronous = NORMAL');   // ì„±ëŠ¥/ì•ˆì •ì„± ê· í˜•
db.pragma('cache_size = -2000');     // 2MB ìºì‹œ
```

### 2.6 ì²´í¬í¬ì¸íŠ¸ ì „ëµ

| ì„¤ì • | ê°’ | ì„¤ëª… |
|------|-----|------|
| `wal_autocheckpoint` | 1000 (ê¸°ë³¸ê°’) | 1000í˜ì´ì§€ë§ˆë‹¤ ìë™ ì²´í¬í¬ì¸íŠ¸ |
| **ê¶Œì¥** | 500~1000 | CrewX íŠ¸ë ˆì´ìŠ¤ ê·œëª¨ì— ì í•© |

---

## 3. ëŒ€ì•ˆ ë¶„ì„

### 3.1 ê²€í† í•œ ëŒ€ì•ˆë“¤

| ë¼ì´ë¸ŒëŸ¬ë¦¬ | ì¥ì  | ë‹¨ì  | ê²°ë¡  |
|-----------|------|------|------|
| **better-sqlite3** | ìµœê³  ì„±ëŠ¥, ë™ê¸° API | - | âœ… **ì„ íƒ** |
| node-sqlite3 | í‘œì¤€ ë¼ì´ë¸ŒëŸ¬ë¦¬ | ë¹„ë™ê¸° ë³µì¡ì„±, ëŠë¦¼ | âŒ |
| sql.js | WebAssembly ê¸°ë°˜ | ë„¤ì´í‹°ë¸Œ ëŒ€ë¹„ ëŠë¦¼ | âŒ |
| Sequelize | ORM ê¸°ëŠ¥ | ì˜¤ë²„í—¤ë“œ, ë¶ˆí•„ìš”í•œ ë³µì¡ì„± | âŒ |

### 3.2 ì €ë„ ëª¨ë“œ ë¹„êµ

| ëª¨ë“œ | ë™ì‹œì„± | ì„±ëŠ¥ | ì•ˆì •ì„± | ê²°ë¡  |
|------|--------|------|--------|------|
| **WAL** | â­â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­ | âœ… **ì„ íƒ** |
| DELETE (ê¸°ë³¸) | â­â­ | â­â­â­ | â­â­â­â­â­ | âŒ |
| TRUNCATE | â­â­ | â­â­â­â­ | â­â­â­â­ | âŒ |
| MEMORY | â­ | â­â­â­â­â­ | â­ | âŒ |

---

## 4. ê²°ë¡  ë° ê¶Œì¥ì‚¬í•­

### 4.1 ê¸°ìˆ  ìŠ¤íƒ ê²°ì •

| êµ¬ì„±ìš”ì†Œ | ì„ íƒ | ê·¼ê±° |
|----------|------|------|
| **SQLite ë¼ì´ë¸ŒëŸ¬ë¦¬** | `better-sqlite3` | ìµœê³  ì„±ëŠ¥, CLI ìµœì í™” |
| **ì €ë„ ëª¨ë“œ** | WAL | ë™ì‹œì„±, ì„±ëŠ¥, ì•ˆì •ì„± |
| **TypeScript íƒ€ì…** | `@types/better-sqlite3` | íƒ€ì… ì•ˆì „ì„± |

### 4.2 êµ¬í˜„ ê¶Œì¥ì‚¬í•­

```typescript
// packages/cli/src/services/tracing.service.ts

import Database from 'better-sqlite3';

export class TracingService {
  private db: Database.Database;

  constructor() {
    this.db = new Database('.crewx/traces.db');
    this.setupPragmas();
    this.initializeSchema();
  }

  private setupPragmas(): void {
    this.db.pragma('journal_mode = WAL');
    this.db.pragma('busy_timeout = 5000');
    this.db.pragma('synchronous = NORMAL');
  }
}
```

### 4.3 íŒ¨í‚¤ì§€ ì„¤ì¹˜

```bash
npm install better-sqlite3
npm install --save-dev @types/better-sqlite3
```

### 4.4 ë¦¬ìŠ¤í¬ ë° ì™„í™” ë°©ì•ˆ

| ë¦¬ìŠ¤í¬ | ì˜í–¥ë„ | ì™„í™” ë°©ì•ˆ |
|--------|--------|----------|
| Native ëª¨ë“ˆ ë¹Œë“œ ì´ìŠˆ | ì¤‘ê°„ | Prebuilt ë°”ì´ë„ˆë¦¬ ì‚¬ìš© (LTS ì§€ì›) |
| ë™ì‹œ ì ‘ê·¼ ì¶©ëŒ | ë‚®ìŒ | `busy_timeout` ì„¤ì •ìœ¼ë¡œ ëŒ€ê¸° |
| WAL íŒŒì¼ ë¹„ëŒ€í™” | ë‚®ìŒ | ìë™ ì²´í¬í¬ì¸íŠ¸ í™œì„±í™” |
| 30ì¼ ì´ìƒ ë°ì´í„° ì¶•ì  | ë‚®ìŒ | `crewx trace clean` ëª…ë ¹ì–´ êµ¬í˜„ |

---

## 5. ë‹¤ìŒ ë‹¨ê³„

1. **WBS-36 Phase 1**: ì´ ê²€í†  ê²°ê³¼ë¥¼ SQLite ìŠ¤í‚¤ë§ˆ ê²€í† ì— ë°˜ì˜
2. **WBS-37 (ì˜ˆì •)**: Observability êµ¬í˜„ ì‹œ better-sqlite3 + WAL ì ìš©
3. **í…ŒìŠ¤íŠ¸**: ë™ì‹œ ì ‘ê·¼ ì‹œë‚˜ë¦¬ì˜¤ (CLI + Slack Bot) í…ŒìŠ¤íŠ¸ ì‘ì„±

---

## ì°¸ê³  ìë£Œ

- [better-sqlite3 npm](https://www.npmjs.com/package/better-sqlite3)
- [better-sqlite3 GitHub](https://github.com/WiseLibs/better-sqlite3)
- [SQLite WAL ê³µì‹ ë¬¸ì„œ](https://sqlite.org/wal.html)
- [WAL Mode - High Performance SQLite](https://highperformancesqlite.com/watch/wal-mode)
- [Understanding Better-SQLite3 - DEV Community](https://dev.to/lovestaco/understanding-better-sqlite3-the-fastest-sqlite-library-for-nodejs-4n8)
- [Speed up SQLite with WAL - DEV Community](https://dev.to/lefebvre/speed-up-sqlite-with-write-ahead-logging-wal-do)
