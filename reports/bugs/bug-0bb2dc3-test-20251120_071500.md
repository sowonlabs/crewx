# Bug Test Report: 0bb2dc3
**Test Date:** 2025-11-20 07:15:00
**Tester:** CrewX Testing Agent
**Bug:** Handlebars token in conversation history causes template parsing error
**Status:** ❌ FAILED - FIX INCOMPLETE

---

## Test Objective

Verify that conversation history containing Handlebars tokens (e.g., `{{#if}}`, `{{#each}}`) doesn't crash the template parser when threads are reused.

## Test Setup

**Environment:**
- Branch: `bugfix/0bb2dc3`
- Build: Successful (all TypeScript types compile)
- CrewX Version: 0.7.4

**Test Data:**
Created test thread `test-handlebars-thread.json` with conversation messages containing Handlebars tokens:
```json
{
  "messages": [
    {"text": "Can you explain Handlebars? {{#if condition}}This is true{{else}}This is false{{/if}}"},
    {"text": "Handlebars is a templating language. You can use {{#each items}}{{this}}{{/each}} to iterate."},
    {"text": "What about {{#if items.length > 0}}complex conditionals{{else}}fallback{{/if}} in templates?"},
    {"text": "You can use {{#each items}}{{#if @first}}First: {{/if}}{{name}}{{/each}} for advanced patterns."}
  ]
}
```

## Test Steps & Results

### Step 1: Build Verification
```bash
npm run build
```
**Result:** ✅ PASSED
- TypeScript compilation successful
- No type errors
- escapeHandlebars helper registered in both layout-renderer.service.ts and template-processor.ts
- Helper implementation: converts `{{` → `&#123;&#123;` and `}}` → `&#125;&#125;`

### Step 2: Thread Reuse Pattern Test
```bash
node packages/cli/dist/main.js query "@claude:haiku what is the next step?" --thread "test-handlebars-thread"
```

**Result:** ❌ FAILED

**Error Output:**
```
❌ [Layout Error] Failed to process layout (crewx/default) for agent claude: Parse error on line 501:
... {{#if items.length > 0}}complex conditi
-----------------------^
Expecting 'CLOSE_RAW_BLOCK', 'CLOSE', 'CLOSE_UNESCAPED', 'OPEN_SEXPR', 'CLOSE_SEXPR', 'ID', 'OPEN_BLOCK_PARAMS', 'STRING', 'NUMBER', 'BOOLEAN', 'UNDEFINED', 'NULL', 'DATA', 'SEP', got 'INVALID'

[Layout Fallback] Using default system prompt
❌ Query failed: Cannot read properties of undefined (reading 'replace')
```

## Root Cause Analysis

### Issue 1: Layout Template Parsing Failure
- **Error Location:** Layout renderer during template compilation (line 501)
- **Error Type:** Handlebars parse error during `Handlebars.compile(layout.template)`
- **Problem:** The layout template (`crewx/default`, 471 lines) somehow contains message text with unparseable Handlebars tokens during compilation

**Hypothesis:** The messages are being embedded into the layout template STRING BEFORE compilation, rather than being passed as separate data. The layout file itself only has 471 lines, but the error occurs at line 501, suggesting content is being prepended or appended.

**Potential Causes:**
1. Message text being embedded into template string during context preparation
2. Layout template being modified before compilation
3. Messages being stringified and injected into the template context value that's used in the template

### Issue 2: TypeError After Layout Fallback
- **Error:** "Cannot read properties of undefined (reading 'replace')"
- **Likely Location:** escapeHandlebars helper trying to call `.replace()` on undefined value
- **Problem:** The helper receives `undefined` instead of a string, suggesting message structure mismatch

### Issue 3: Fix Incompleteness
The applied fix (commit d350aba) adds `escapeHandlebars` helper and calls `{{{escapeHandlebars text}}}` in the conversation formatting template. However:

1. **Helper is not active during layout compilation** - The helper is registered INSIDE the formatConversation helper function, not globally
2. **Messages are escaped too late** - By the time escapeHandlebars is called, the layout template may already have failed to compile
3. **Message structure may not match expectations** - The loaded conversation messages may not have the expected `text` property structure

## Technical Details

### Actual Fix Implemented (Commit d350aba)
```typescript
// Helper registered in template-processor.ts (lines 189-195)
Handlebars.registerHelper('escapeHandlebars', function(text: string): string {
  if (typeof text !== 'string') {
    return '';
  }
  return text.replace(/\{\{/g, '&#123;&#123;').replace(/\}\}/g, '&#125;&#125;');
});

// Used in conversation formatting template (line 284)
{{/if}}: {{{escapeHandlebars text}}}
```

### What Should Happen
1. ✅ Layout template compiles successfully
2. ✅ Layout is rendered with message data
3. ✅ formatConversation helper is invoked with message array
4. ✅ escapeHandlebars helper escapes Handlebars tokens in message text
5. ✅ Conversation history is formatted without parse errors

### What Actually Happens
1. ❌ Layout template fails to compile with parse error on line 501
2. ❌ Error references message text from conversation: "{{#if items.length > 0}}complex conditi..."
3. ❌ System falls back to default prompt
4. ❌ Query executes with fallback prompt (bypassing formatConversation)
5. ❌ TypeError when escapeHandlebars receives undefined

## Recommendations

### Immediate Investigation Needed
1. **Check where messages are embedded into template string:**
   - Search for string concatenation with messages in layout rendering pipeline
   - Verify messages are passed as DATA not as template string substitutions
   - Check RenderContext.messages handling in layout-renderer.service.ts

2. **Verify message loading structure:**
   - Inspect actual message objects from conversation storage
   - Ensure they have expected properties (id, text, role, isAssistant, metadata)
   - Check if text field contains the Handlebars tokens

3. **Test message escaping at load time:**
   - Consider escaping messages when loading from conversation file
   - This would prevent the tokens from ever reaching template compilation

4. **Deeper fix options:**
   - **Option A:** Escape messages at load time in ConversationStorageService
   - **Option B:** Pre-escape messages before adding to RenderContext
   - **Option C:** Use raw block wrapper (`{{{{raw}}}}...{{{{/raw}}}}`) in layout template
   - **Option D:** Validate that messages are never embedded as template string content

## Test Artifacts

**Test Thread File:**
`/Users/doha/git/crewx/worktree/bugfix-0bb2dc3/.crewx/conversations/test-handlebars-thread.json`

**Test Command:**
```bash
cd /Users/doha/git/crewx/worktree/bugfix-0bb2dc3
node packages/cli/dist/main.js query "@claude:haiku what is the next step?" --thread "test-handlebars-thread"
```

## Next Steps

1. **Retest after investigating message embedding issue**
2. **Implement deeper fix if escapeHandlebars helper is insufficient**
3. **Test with actual production wbs-loop.sh thread reuse pattern**
4. **Verify no regressions with threads containing normal conversation history**

---

**Test Conclusion:** The fix (commit d350aba) appears incomplete. The escapeHandlebars helper is added but not sufficient because the parse error occurs BEFORE the helper can be invoked. Further investigation into how messages are embedded in the template context is needed.
